\chapter{Un modèle primal pour les surfaces planes}
\label{chapitre:primal_jolimas}
\defineHeaderForClassicalChapter
\graphicspath{{images/Ch3/}}

\begin{chapeauChapitre}
	Comme évoqué dans le chapitre \ref{chapitre:etat_de_lart} état de l'art, à l'opposé des méthodes d'illumination locale et d'illumination globale, il est intéressant de considérer la lumière comme un élément géométrique car le comportement d'une spécularité est très similaire à celui d'un objet réfléchi dans un miroir. Nous explorons cette piste dans ce chapitre par un exemple relativement simple (une surface plane) mais permettant de mettre en évidence nos premières hypothèses et le principe général de notre modèle géométrique pour la prédiction de spécularités.
\end{chapeauChapitre}

\section{Introduction}
Le phénomène photométrique des spécularités est souvent présent dans les images. En effet, ces éléments se manifestent sur une surface lorsque la taille des imperfections de celle-ci est inférieure ou de l'ordre de grandeur de la longueur d'onde incidente. C'est pourquoi une surface de métal brut qui diffuse fortement devient parfaitement réfléchissante quand on la polit (on l'abrase jusqu'à ce que la taille des défauts soit comparable à la longueur d'onde de la lumière). Dans ces conditions, la lumière est complètement réfléchie sous une forme spéculaire (l'angle du rayon de lumière incident avec la normale de la surface à un point de surface donné est égal à l'angle de rayon réfléchi avec la normale). Si cette lumière réfléchie rencontre l'objectif de la caméra, une spécularité est créée dans l'image. De ce fait, ces éléments sont importants dans plusieurs domaines. En vision par ordinateur et traitement d'image, elles provoquent une augmentation de l'intensité de l'image ce qui a pour effet de perturber les algorithmes de détection ou de suivi 2D/3D, de localisation de caméra ou encore de reconstruction 3D. 

Cependant, si on les considère comme des primitives de localisation, leur présence apporte des informations pertinentes permettant une meilleure estimation de la profondeur d'une scène et donc de sa géométrie permettant d'améliorer la localisation de caméra \cite{lagger20083d, meilland2011real, silveira2007real}, la reconstruction 3D \cite{fleming2004specular, savarese2004reflections} et l'analyse de matériaux d'une scène \cite{chang20093d, netz2013recognition, netz2013recognitionpami, shroff2011finding}. En réalité augmentée (RA) ou en infographie, ces primitives permettent d'augmenter significativement le réalisme du rendu des applications \cite{csongei2014global, gruber2014efficient, hachisuka2008progressive, jachnik2012realtime, jarosz2008beam, knorr2014real, rohmer2014interactive, sato1999acquiring}. Il a été montré dans les études de \cite{blake1990does} que les spécularités jouent un rôle important dans la perception de la profondeur et du relief d'un objet. Afin d'améliorer le plus possible ces applications, il est intéressant de pouvoir prédire les spécularités dans une scène pour un point de vue donné.

Nous avons observé empiriquement que la forme de la spécularité sur une surface plane peut être modélisée par une ellipse. De plus, nous savons qu'une ellipse est issue de la projection d'une quadrique sur un plan. À partir de ces éléments, il est naturel de se demander s'il est possible de reconstruire une quadrique fixe dont la projection correspond aux spécularités pour chaque point de vue. Dans ce cas, ce modèle représenterait un lien entre le phénomène photométrique des spécularités (lumières et matériaux) et la géométrie multi-vues \cite{Hartley2004}.

Nous proposons un modèle empirique que nous avons nommé \textit{JOint LIght-MAterial Specularity} (JOLIMAS) permettant de prédire facilement la position et la forme des spécularités pour de nouveaux points de vue comme illustré à la figure \ref{fig:real_data}. Ce modèle est composé d'une quadrique qui inclut les propriétés des lumières et des matériaux de la scène. Cette quadrique est reconstruite à partir de chaque ellipse associée à une spécularité observée sur une surface plane, pour un point de vue donné. Dans ce chapitre, nous présentons les différents modèles physiques utilisés en général en vision par ordinateur et analysons leur capacité à prédire le phénomène complexe des spécularités. Nous travaillons essentiellement sur des surfaces planes car il est facile de retrouver ce type de surface dans une scène, comme exploité dans \cite{buteau2015poster, jachnik2012realtime}. L'extension de ce modèle à des surfaces plus complexes requiert une étude approfondie qui fera l'objet des chapitres \ref{chapitre:dual_jolimas} et \ref{chapitre:modele_general}.

 Notre modèle est présenté dans la section \ref{sec:approche_proposee_primal}. Son estimation est développée dans la section \ref{sec:model_estimation} en comparant différentes approches de l'état de l'art. Notre modèle et sa capacité à prédire les spécularités ont été testés sur des séquences de synthèse et réelles comprenant des sources de lumière de type ampoule et néon dans la section \ref{sec:resultats_experimentaux}. Nous illustrons également la capacité de notre modèle à gérer plusieurs sources de lumière et des lumières à état changeant (allumées et éteintes) dans le chapitre \ref{chapitre:RA}.

% =============================================================================
\section{Approche proposée} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\label{sec:approche_proposee_primal} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% =============================================================================
Nous partons de l'observation qu'une spécularité présente une forme elliptique sur une surface plane.  Si une ellipse correspond à la projection perspective d'une quadrique, existe-il une quadrique fixe dans l'espace dont la projection perspective correspond aux spécularités ? Dans ce cas, un modèle faisant abstraction des paramètres physiques liés à l'apparition de la spécularité peut être obtenu.

Nous proposons un modèle empirique incluant les propriétés des sources de lumière et des matériaux en reconstruisant une quadrique issue des ellipses appliquées aux spécularités pour chaque point de vue comme illustré sur la figure \ref{fig:dessin}. Nous assumons des surfaces planes non-Lambertiennes où chaque spécularité est associée à une source de lumière. Notre étude se concentre sur ce modèle permettant de prédire les spécularités provenant de n'importe quel type de lumière.

Une démonstration de notre approximation de la spécularité, observée sur une surface plane, par une ellipse est détaillée dans les sections suivantes. Nous évaluerons empiriquement cette hypothèse dans la section \ref{sec:validation}.

\begin{figure}[!ht]
   \centering	  
  \includegraphics[width=\linewidth]{main_schema.pdf}
   \caption{Lien entre le modèle physique (lumière et matériaux) et la géométrie multi-vues (notre modèle empirique). À partir de plusieurs points de vue, une quadrique est reconstruite à partir de spécularités de forme elliptique. Cette quadrique virtuelle projetée sur chaque point de vue correspond aux spécularités.}
  \label{fig:dessin}
\end{figure}

% =============================================================================
\section{Motivation théorique} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\label{sec:motivation_theorique_primal} %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% =============================================================================
Dans cette section, nous mettons en évidence l'utilisation des modèles classiques d'illumination locale comme Phong et Blinn-Phong comme base théorique de notre modèle. En effet, dans ces modèles, afin d'assurer un rendu rapide et cohérent, de nombreuses approximations sont réalisées sur l'interaction lumière/matériau. Ces approximations sont judicieuses à étudier car elles fournissent une fondation intéressante pour l'abstraction des paramètres physiques liés à l'apparition de la spécularité de notre modèle. L'objectif de cette section est de montrer que notre hypothèse de spécularité de forme conique (et plus spécifiquement elliptique) est cohérente et se retrouve également dans les modèles d'illumination locale.
\subsection{Modèles de Phong et Blinn-Phong}
Nous utilisons le modèle d'illumination de \cite{phong1975illumination} qui est à la base de nombreuses modèle de BRDF \cite{hughes2012calculating}. Nous n'utilisons pas le modèle de Phong pour reconstruire notre modèle JOLIMAS mais plutôt comme un moyen théorique de développer certaines de ses propriétés fondamentales. Ce modèle d'illumination divise l'image en 3 composantes : diffuse, ambiante et spéculaire. Des modèles plus récents comme ceux de \cite{blinn1977models}, \cite{ward1994radiance}, \cite{cook1982reflectance} diffèrent majoritairement dans le calcul du terme spéculaire. Ces modèles proposent également une estimation de la rugosité qui correspond à la micro géométrie d'une surface et est un élément important dans la perception et le réalisme d'un matériau. Même si le modèle de Phong est considéré comme obsolète dans les méthodes de rendu photo-réaliste, il convient bien pour expliciter l'approximation effectuée dans notre étude de par sa simplicité analytique.

La fonction d'intensité du modèle de \cite{phong1975illumination} d'un point 3D sur une surface est donnée par la formule :
\begin{equation}
 \begin{aligned}
       I(\mathbf{p}) =  i_a k_a + i_d k_d (\hat{\mathbf{L}}\mathbf{(\mathbf{p})}\cdot \hat{\mathbf{N})} + i_s k_s (\hat{\mathbf{R}}(\mathbf{p}) \cdot \hat{\mathbf{V}}(\mathbf{p}))^n,
 \end{aligned}
    \label{eq:phong}
\end{equation}
avec \mbox{$\hat{\mathbf{R}}(\mathbf{P}) = -\mathop{\mu}(\mathbf{R} - \mathbf{P})$} la direction normalisée d'un rayon réfléchi de lumière \mbox{$\setlength\arraycolsep{2pt} \mathbf{L} = \begin{bmatrix}L_X & L_Y & L_Z \end{bmatrix}^\top$} tel que $\setlength\arraycolsep{2pt} \mathbf{R} = \begin{bmatrix}L_X & L_Y & -L_Z \end{bmatrix}^\top$, $\hat{\mathbf{L}}$ et $\hat{\mbf{V}}$ la direction normalisée du point de vue orientée vers la source de lumière $\mathbf{L}$ et le capteur \mbox{$\setlength\arraycolsep{2pt} \mathbf{V} = \begin{bmatrix}V_X & V_Y & V_Z \end{bmatrix}^\top$}, $n$ la brillance de la surface, $k_s$, $k_a$ et $k_d$ le ratio de réflexion des termes spéculaire, ambiant et diffus de la lumière incidente, $\hat{\mbf{N}}$ la normale de la surface $S$ et $i_s$, $i_a$ et $i_d$ l'intensité entrante sur la surface pour les termes spéculaire, ambiant et diffus.

Notre repère monde est choisi tel que la surface $S \subset \mathbb{R}^3$ correspond au plan $(\vect{X}\vect{Y})$ et $S = \{\vect{P} \in \mathbb{R}^3 | P_Z = 0\}$. Nous pouvons paramétrer $S$ par le point $\setlength\arraycolsep{2pt} \mathbf{P} = \begin{bmatrix}P_X  & P_Y & P_Z\end{bmatrix}^\top$. 

\subsection{Terme spéculaire}
Au point $\vect{P}$, la composante spéculaire $I_s$ est donnée par l'équation :
\begin{equation}
	I_s(\mathbf{P}) = \max(0,(\hat{\mathbf{R}}(\mathbf{P}) \cdot \hat{\mathbf{V}}(\mathbf{P}))^n).
\end{equation}
Nous voulons analyser les isocontours d'une spécularité sur une surface $S$ et pour un point de vue $\vect{V}$, une source de lumière $\vect{L}$ et $\vect{R}$. Nous partons du modèle de réflexion exprimé par :
\begin{equation}
\tilde{I}_s(\mathbf{P}) = - \mu(\mathbf{R} - \mathbf{P})^\top \mu(\mathbf{V} - \mathbf{P}).
\label{eq:simple_phong}
\end{equation} 
Dans un premier temps, nous développons Eq.\ref{eq:simple_phong} pour un $\tau$ général en la résolvant pour $\tau = 1$ et $\tau = 0$.
\begin{equation}
\tilde{I}_s(\mathbf{p}) = \tau.
\label{eq:phong_tau}
\end{equation}
$\tilde{I}_s$ est un produit scalaire entre deux vecteurs normalisés, nous avons $-1 \leq \tilde{I}_s \leq 1$. De plus, puisque $P_Z = 0$, $L_Z > 0$ et $V_Z > 0$, $\tilde{I}_s$ > 0, de manière générale, $0 < \tilde{I}_s \leq 1$.
En multipliant l'équation \eqref{eq:phong_tau} $\| \mathbf{R} - \mathbf{P} \| \| \mathbf{V} - \mathbf{P} \|$, en mettant l'expression au carré et en soustrayant la partie de droite, nous obtenons une quartique à deux variables (en $P_X$ and $P_Y$):
\begin{equation*}
\big( ( \mathbf{R} - \mathbf{P})^\top (\mathbf{V} - \mathbf{P}) \big)^2 - \tau^2 \| \mathbf{R} - \mathbf{P} \|^2 \|  \mathbf{V} - \mathbf{P}\|^2 = 0.
\end{equation*}

En développant le terme spéculaire à l'équation \eqref{eq:phong} et en rassemblant les monômes de même degré, on obtient :
\begin{flalign*}
(d^\circ 4) \text{    }& (1 - \tau^2)|| \mathbf{P} ||^4 \\ 
(d^\circ 3) \text{    }&   2(\tau^2 - 1)(\mathbf{R} + \mathbf{V})^\top\mathbf{P}||\mathbf{P}||^2 \\
(d^\circ 2) \text{    }& \mathbf{P}^\top (\mathbf{R}\mathbf{R}^\top + 2\tau(1 - 2\tau^2)\mathbf{R}\mathbf{V}^\top + \\ &(2\mathbf{R}^\top\mathbf{V} - \tau^2 ||\mathbf{R} ||^2 - \tau^2 ||\mathbf{V} ||^2)\mathtt{I})\mathbf{P}\\
(d^\circ 1) \text{    } &2(-\mathbf{R}^\top\mathbf{V}\mathbf{R}^\top - \mathbf{R}^\top\mathbf{V}\mathbf{V}^\top + \\ 
&\tau^2 || \mathbf{R}||^2\mathbf{V}^\top + \tau^2 || \mathbf{V}||^2 \mathbf{R}^\top)\mathbf{P}\\
(d^\circ 0) \text{    } &(\mathbf{R}^\top\mathbf{V})^2 - \tau^2 ||\mathbf{R} ||^2 ||\mathbf{V} ||^2.
\end{flalign*}
Pour $\tau = 1$, les monômes de degré 3 et 4 disparaissent tel que les termes restants forment une équation quadratique tel que :
\begin{equation}
\mathbf{\tilde{P}}^\top \mathtt{Q} \mathbf{\tilde{P}} = 0,
\end{equation}
où $\tilde{\mathbf{P}} \overset{\mathrm{def}}{=\joinrel} \begin{bmatrix} \mathbf{P} & 1 \end{bmatrix}^\top$ sont les coordonnées homogènes de $\vect{P}$. La matrice $\mathtt{Q} \in \mathtt{R}^{4 \times 4}$ est symétrique et définie par :
\begin{equation*}
\mathtt{Q} = \begin{bmatrix}
[\mathbf{R} - \mathbf{V}]^2_\times & [\mathbf{V}\times \mathbf{R}]_\times (\mathbf{V} - \mathbf{R}) \\
 ([\mathbf{V}\times \mathbf{R}]_\times (\mathbf{V} - \mathbf{R}))^\top & (\mathbf{R}^\top\mathbf{V})^2 - ||\mathbf{R} ||^2 ||\mathbf{V} ||^2
\end{bmatrix}
\end{equation*}
Nous observons que la somme des termes de degrés 3 et 4 donne:
\begin{equation}
(1 - \tau^2) ||\mbf{P} ||^2 \mbf{P}^\top(\mbf{P} - 2\mbf{R} - 2\mbf{V}).
\end{equation}

\subsubsection{Point d'intensité maximale}
A la valeur d'intensité maximale $\tau = 1$, les monômes de degrés 3 et 4 disparaissent. Les termes restants forment une équation quadratique qui peut être réécrite de la manière suivante:
\begin{equation}
\mathbf{\tilde{P}}^\top \mathtt{J} \mathbf{\tilde{P}} = 0,
\end{equation}
où $\tilde{\mathbf{P}} \overset{\mathrm{def}}{=\joinrel} \begin{bmatrix} \mathbf{P} & 1 \end{bmatrix}^\top$ sont les coordonnées homogènes de $\mathbf{P}$. La matrice $\mathtt{J}\in \mathbb{R}^{4\times 4}$ est symétrique et définie par:
\begin{equation*}
\mathtt{J} = \begin{bmatrix}
[\mathbf{R} - \mathbf{V}]^2_\times & [\mathbf{V}\times \mathbf{R}]_\times (\mathbf{V} - \mathbf{R}) \\
 ([\mathbf{V}\times \mathbf{R}]_\times (\mathbf{V} - \mathbf{R}))^\top & (\mathbf{R}^\top\mathbf{V})^2 - ||\mathbf{R} ||^2 ||\mathbf{V} ||^2
\end{bmatrix}
\end{equation*}

Nous avons montré dans l'appendice \ref{annexe:analysis_phong_blinn} que $\mathop{\text{rang}}(\mathtt{J}) = 2$ et $\mathtt{J}$ est non-négative. Ce qui signifie que $\mathtt{J}$ est une quadrique de classe point ce qui représente une ligne contenant $\mathbf{R}$ et $\mathbf{V}$. Son intersection avec $S$ est définie comme étant le point d'intensité maximale. En conséquence, la spécularité a un point d'intensité maximale bien défini et unique.

\subsubsection{Contour externe}
Pour comprendre en détail la structure du problème, l'Eq.\ref{eq:phong_tau} est résolue pour $\tau = 0$ ce qui révèle la nature du contour externe. En développant le terme spéculaire de Eq.\ref{eq:phong}, on obtient :
\begin{equation}
\|\mathbf{P}\|^2 - (\mathbf{R} + \mathbf{V})^\top\mathbf{P} + \mathbf{R}^\top \mathbf{V} = 0,
\end{equation}
ce qui correspond à une quadrique et plus particulièrement une sphère décrite par la matrice :
\begin{equation}
\mathtt{J} = \begin{bmatrix}
\mathtt{I}_3 & -\frac{1}{2}(\mathbf{R} + \mathbf{V}) \\
-\frac{1}{2}(\mathbf{R} + \mathbf{V})^\top & \mathbf{R}^\top\mathbf{V}
\end{bmatrix}.
\end{equation}
En définissant la projection orthographique sur $S$ :
\begin{equation}
\mathtt{A} = \begin{bmatrix}
1 & 0 & 0 \\
0 & 1 & 0 \\
0 & 0 & 0 \\
0 & 0 & 1
\end{bmatrix},
\end{equation}
le contour de la spécularité est donné par la conique :
\begin{equation*}
\mathtt{C} = \mathtt{A}^\top \mathtt{J}\mathtt{A} = 
\begin{bmatrix}
\mathtt{I}_2 & -\frac{1}{2}(\mathbf{\bar{R}} + \mathbf{\bar{V}}) \\
-\frac{1}{2}(\mathbf{\bar{R}} + \mathbf{\bar{V}})^\top & \mathbf{R}^\top \mathbf{V}
\end{bmatrix},
\end{equation*}
avec  $\mathbf{\bar{R}} \overset{\mathrm{def}}{=\joinrel} \setlength\arraycolsep{2pt} \begin{bmatrix} R_X, R_Y\end{bmatrix}^\top$ et $\mathbf{\bar{V}} \overset{\mathrm{def}}{=\joinrel} \setlength\arraycolsep{2pt} \begin{bmatrix} V_X, V_Y  \end{bmatrix}^\top$ correspondent aux projections orthographiques de $\mathbf{R}$ et $ \mathbf{V}$ sur $S$ respectivement. $\mathtt{C}$ représente un cercle pour $\tau = 0$.

En observant le cercle  $\mathtt{C}$ sur le plan image de la caméra de centre optique $\vect{V}$, une conique est obtenue et plus particulièrement une ellipse si la spécularité est contenue entièrement dans le plan image.

\subsubsection{Isocontours internes}
Afin d'étudier les contours internes correspondant à une valeur de $\tau \in [0, 1]$ arbitraire, les réflexions spéculaires peuvent être approximées par une ellipse dans le modèle de Phong comme illustré dans la figure \ref{fig:phong_closeup}. Cette approximation a également été testée et validée sur le modèle de \cite{blinn1977models} comme illustré à la figure \ref{fig:blinn_closeup}. Initialement, ce modèle a été défini en tant qu'approximation du modèle de Phong et régulièrement présenté en infographie comme un modèle plus précis en comparaison avec Phong. Ce modèle est aussi  considéré comme physiquement plus cohérent car il vérifie l'équation de Helmholtz \cite{haines2002real}.

Cette démonstration illustre la pertinence et la précision d'une modélisation d'une spécularité par une ellipse. Afin de démontrer davantage cette propriété, une validation empirique sur des données de synthèse est réalisée dans la prochaine section.

\begin{figure}[!ht]
\centering
\subfigure[Phong, source ponctuelle]
{
    \includegraphics[width=0.47\linewidth]{phong_closeup.pdf}
    \label{fig:phong_closeup}
}
\subfigure[Blinn-Phong, source ponctuelle]
{
    \includegraphics[width=0.47\linewidth]{blinn_closeup.pdf}
    \label{fig:blinn_closeup}
}
\subfigure[Phong, source étendue]
{
     \includegraphics[width=0.47\linewidth]{phong_closeup_extended.pdf}
     \label{fig:phong_closeup_extended}
}
\subfigure[Blinn-Phong, source étendue]
{
     \includegraphics[width=0.47\linewidth]{blinn_phong_extended.pdf}
     \label{fig:blinn_phong_extended}
}
\caption{Illustration de notre hypothèse de spécularités de forme elliptique. Une spécularité est créée à partir du terme spéculaire du modèle de réflexion de Phong dans (a) pour une simple lumière ponctuelle, et dans (c) pour une source de lumière étendue (une ligne composée de plusieurs sources ponctuelles) et à partir du terme spécularité du modèle de réflexion de Blinn-Phong dans (b) pour une simple lumière ponctuelle et dans (d) pour une source de lumière étendue. Les spécularités sont clairement de forme elliptique dans tous ces cas. En observant ces formes dans le plan images, nous obtenons des ellipses. Nous montrons dans ces exemples les différents isocontours associés à une intensité spécifique $\tau \in \{0, 0.5, 0.9\}$ (contours en vert, rouge et bleu) ainsi que les ellipses correspondantes (en pointillés verts, rouges et bleus). Notre hypothèse de spécularité elliptique est distinctement vérifiée dans ces exemples.}
\end{figure}

\subsection{Validation empirique de l'hypothèse  du modèle à partir de données simulées}
\label{sec:validation}

Afin de valider notre approximation de spécularités, nous utilisons la méthode de \cite{fitzgibbon1996buyer} d'estimation d'ellipse pour différentes valeurs de $\tau \in [0, 1]$ sur la partie spéculaire uniquement et ensuite sur la partie diffuse combinée à la partie spéculaire. Dans un contexte de RA, les composantes diffuse et spéculaire sont corrélées. Afin de calculer nos données synthétiques, nous générons des images $2000 \times 2000$ en utilisant les modèles d'illumination locale de \cite{phong1975illumination} et \cite{blinn1977models} à partir d'une position aléatoire de source lumineuse et d'une caméra localisées au-dessus de la surface plane de taille fixe. L'objectif est d'analyser la forme de la spécularité pour une intensité fixe $\tau \in [0, 1]$. Pour chaque valeur de $\tau$, avec un pas de $0.05$ entre chaque valeur, nous lançons 1000 scénarios de position de lumière et de pose de caméra. L'erreur d'estimation de l'ellipse sous forme d'une distance point/point entre les isocontours et l'ellipse correspondante est calculée par la méthode de \cite{sturm2007conic}. Cette distance est calculée pour chaque scénario. La validation empirique de l'estimation d'ellipse est donnée par la figure \ref{fig:final_theoretical} pour des sources de lumière ponctuelles et par la figure \ref{fig:extended_theoritical} pour des sources étendues. En infographie, les sources étendues sont souvent représentées comme un ensemble de sources de lumière ponctuelles \textit{e.g} une ligne pour représenter un néon.

\begin{figure}[!ht]
   \centering	 
    \subfigure[Source ponctuelle]
	{
        \includegraphics[width=0.85\linewidth]{empirical_validation.pdf}	
        \label{fig:final_theoretical}
    }   
    \subfigure[Source étendue]
	{
        \includegraphics[width=0.85\linewidth]{empirical_extended.pdf}          
        \label{fig:extended_theoritical}	
    }   
     
\caption{Validation empirique à partir de données synthétiques pour (a) des sources de lumière ponctuelles et (b) des sources de lumière étendues. Notre hypothèse de spécularités de forme elliptique est testée sur les modèles d'illumination de Phong (P) et de Blinn-Phong (BP) pour différentes valeurs de $\tau \in [0, 1]$. Cette hypothèse est testée pour le terme spéculaire dans un premier temps et en combinant les termes spéculaire et diffus combinés.}
\label{fig:empirical}
\end{figure}

Cette erreur est calculée sous forme d'un ratio entre la distance géométrique ellipse/contours avec le diamètre de l'ellipse en pixels pour $\tau = 0$. Les résultats montrent que notre approximation correspond aux données de synthèse avec moins de $0.2\%$ d'erreur pour le modèle de Phong et $0.6\%$  pour le modèle de Blinn-Phong pour une source de lumière ponctuelle et une erreur moyenne de $0.7\%$ et $1.3\%$ respectivement pour les modèles de Phong et Blinn-Phong pour une source étendue. Ces résultats confirment la fiabilité et la précision de notre représentation elliptique de spécularité pour les sources de lumière ponctuelles et étendues. Pour les sources étendues comme les néons, notre  approximation d'ellipses est toujours pertinente comme illustré à la figure \ref{fig:extended_theoritical}. Notre montrons empiriquement qu'une quadrique fixe et unique existe à partir de plusieurs points de vue et qui justifie les formes elliptiques des spécularités dans la section \ref{sec:validation_synt}.

\section{Estimation du modèle}
\label{sec:model_estimation}
Nous avons montré dans la section \ref{sec:validation} qu'une spécularité observée sur une surface plane peut être approximée par une ellipse. La contribution principale de notre méthode est de pouvoir représenter chaque lumière par une quadrique $\mathtt{Q}$ associée par les projections (spécularités) sur un plan $S$ pour une matrice de projection donné $\mathtt{\Pi} = \mathtt{K} \begin{bmatrix}\mathtt{R}_{rot} & \mathbf{V} \end{bmatrix}$.

\subsection{Vue globale}
Le pipeline de la méthode proposée est divisé en plusieurs étapes :
\begin{itemize}
\item Detection de spécularité dans les images par notre approche expliquée dans l'annexe \ref{annexe:specularity_detection}
\item Calcul de l'ellipse enveloppant les spécularités \cite{fitzgibbon1996buyer}
\item Reconstruction de quadrique \cite{cross1998quadric}
\item Prédiction de spécularité par projection de quadrique
\end{itemize}
Notre processus de détection de spécularité est divisé en 3 étapes. Dans un premier temps, afin de réduire le bruit dans l'image et le contexte lumineux dynamique; par la suite, en réalisant un seuillage automatique par l'intermédiaire d'une valeur moyenne de luminance. Enfin, afin de réduire davantage les mauvaises détections, la méthode utilise un critère d'intensité de gradient afin de discriminer les surfaces spéculaires des textures blanches détectées à tort. Cette méthode assume que l'intensité d'une spécularité est isotropique et décroissante à partir du point d'intensité maximale. Le processus de calcul d'ellipse englobante utilise une image en niveaux de gris en sortie du processus de détection de spécularité afin de fournir les ellipses d'entrée pour le processus de reconstruction de quadrique. Le détail de notre méthode de détection est fourni dans l'annexe \ref{annexe:specularity_detection}.

\subsection{Reconstruction de quadrique par la méthode de Cross\etal}
Nous utilisons l'approche de \cite{cross1998quadric} qui reconstruit une quadrique duale $\mathtt{Q}^*$ à partir de plusieurs coniques duales $\mathtt{C}^*$ en reformulant la relation :
\begin{equation}
	\mathtt{\Pi}\mathtt{Q}^*\mathtt{\Pi}^\top = \mathtt{C}^*.
	\label{eq:conicdual}
\end{equation}
La vectorisation de l'équation \eqref{eq:conicdual} est donnée dans l'appendice \ref{sec:vectorization_appendix}. Par vectorisation de $\mathtt{Q}^*$ et $\mathtt{C}^*$ en $\vect{Q}^*_v$ et $\vect{C}^*_v$, nous posons l'équation \eqref{eq:linearsystem} avec $\mathtt{C}$ nos spécularités modélisées en ellipses et $\mathtt{Q}$ notre modèle de prédiction représenté en quadrique pour $n$ points de vue tels que $n \geq 3$. Nous construisons le système :
\begin{equation*}
 \begin{aligned}
       \mathtt{M}\mathtt{w} = 0,
 \end{aligned}
    \label{eq:svd}
\end{equation*}
avec
\begin{equation}
\begin{aligned}
\underbrace{\begin{pmatrix}
       \mathtt{B}_{1} & -\mbf{C}_{1, v}^* & 0 & \ldots & 0            \\[0.3em]
       \mathtt{B}_{2} & 0 & -\mbf{C}_{2, v}^* & & 0  \\[0.3em]
       \vdots  & 0 & 0 & \ddots & \vdots \\
       \mathtt{B}_{n} & 0 & 0 &  \ldots & -\mbf{C}_{n, v}^*    
 \end{pmatrix}}_{\mathtt{M}}
\underbrace{\begin{pmatrix}
       \mbf{Q}_v^*     \\[0.3em]
       \alpha_1  \\[0.3em]
       \alpha_2   \\[0.3em]
      \vdots \\[0.3em]
      \alpha_n
\end{pmatrix}}_{\mathtt{\mathtt{w}}} = 0,
 \end{aligned}
    \label{eq:linearsystem}
\end{equation}
avec la matrice $\mathtt{B}_i \in \mathbb{R}^{6 \times 10}$. La solution de ce système linéaire est illustré par l'équation \ref{eq:linearsystem} qui est calculée par décomposition en valeurs singulières (SVD) de $\mathtt{M}$. $\alpha_i$ correspond à l'échelle pour l'image d'indice $i$ telle que : $ \alpha_i  \mbf{C}_{i, v}^* = \mathtt{B}_i \mbf{Q}_{i, \mathtt{v}}^*$. Le processus de reconstruction de la quadrique est illustré à la figure \ref{fig:dessin}. Cependant, le système \eqref{eq:linearsystem} est relativement sensible aux erreurs du calcul des ellipses en entrée. Afin d'assurer la qualité des ellipses en entrée utilisées pour la reconstruction, nous utilisons un procédé de correction épipolaire des ellipses en entrée. Cette correction assure que les ellipses respectent la contrainte épipolaire avant le procédé initial de reconstruction de quadrique. Afin d'améliorer la reconstruction de quadrique, un raffinement non-linéaire est proposé.



%=============================================================================
\section{Résultats expérimentaux} 
\label{sec:resultats_experimentaux}
% ==============

Afin d'évaluer la pertinence et la précision de notre modèle, deux expériences sont réalisées. Nous analysons, dans un premier temps, la performance de notre modèle pour la prédiction de spécularité sur des données de synthèse générées à partir du modèle de Phong et Blinn-Phong. Cette capacité de prédiction est ensuite évaluée sur cinq séquences réelles incluant des sources de lumière de différents types comme les ampoules ou les néons.

\subsection{Validation du modèle sur des données de synthèse}
\label{sec:validation_synt}

Dans cette section, nous détaillons la validation de notre approximation de quadrique sur des données de synthèse. La caméra utilisée a une distance focale de $50mm$ avec le point principal centré dans l'image. La taille des pixels est de $0.45 \times 0.45mm$ pour une résolution de $1000\times 1000$ pixels. Notre scène est constituée d'un plan réfléchissant de $20\times20cm$ où l'on observe une spécularité en mouvement. Nous sélectionnons aléatoirement les points de vue et la position de la source de lumière au-dessus du plan. À partir des modèles d'illumination de Phong et Blinn-Phong pour tout $\tau \in [0,1]$, 100 quadriques sont estimées par le biais de 100 points de vue. Nous calculons la distance géométrique entre les termes diffus et spéculaire combinés avec la projection de quadrique associée au point de vue au sens de notre distance Ellipse/Point.
\begin{figure}[!ht]
   \centering	 
   \subfigure[Source ponctuelle]
   {
          \includegraphics[width=\linewidth]{final_synth.pdf}
   }
   \subfigure[Source étendue]
   {
          \includegraphics[width=\linewidth]{final_synth_extended.pdf}
   }	  
\caption{Validation de notre modèle en mesurant l'erreur de prédiction sur des données synthétiques pour une source de lumière ponctuelle (a) et une source de lumière étendue (b). A partir de 100 points de vues, une quadrique fixe est reconstruite et sa projection est comparée avec les contours de la spécularité pour chaque point de vue en utilisant notre distance Ellipse/Point. Cette erreur est normalisée en fonction de la dimension de la scène.}
\label{fig:quadric_therical}
\end{figure}
Comme illustré à la figure \ref{fig:quadric_therical}, notre approximation par quadrique est efficace pour la prédiction de spécularité pour tout $\tau \in [0, 1]$ pour les modèles de Phong et Blinn-Phong avec respectivement $0.3\%$ et $0.45\%$ d'erreur en moyenne en fonction de la taille de la scène.
Cette expérience a été également réalisée pour des sources de lumière étendues composées de plusieurs
sources ponctuelles pour les modèles d'illumination de Phong et Blinn-Phong pour une erreur moyenne de $1\%$ et $1.6\%$ respectivement. On peut noter que le processus de raffinement ne joue pas un rôle significatif sur des données de synthèse où les conditions sont idéales.

\subsection{Données réelles}
Nous évaluons notre modèle JOLIMAS sur des séquences réelles avec trois sources de lumière différentes et cinq matériaux différents. La quadrique est reconstruite à partir des ellipses calculées par la méthode de \cite{fitzgibbon1996buyer}. Les spécularités sont détectées en utilisant notre méthode de détection de spécularité \cite{morgand2014generic}. Les poses de caméra sont calculées en utilisant une méthode de SLAM \cite{tamaazousti2011nonlinear}. Le processus de reconstruction est basé sur une méthode temps-réel et la prédiction est également réalisée en temps réel en projetant perspectivement la quadrique reconstruite pour une pose de caméra donnée. La projection de cette quadrique donne une ellipse correspondant à la prédiction pour la pose de caméra. Elle est obtenue par la formule :
\begin{equation}
	\mathtt{C} = (\mathtt{\Pi}\mathtt{Q}^*\mathtt{\Pi}^\top)^*.
	\label{eq:quad_proj}
\end{equation}

La précision de notre modèle JOLIMAS est évaluée sur des données réelles afin de quantifier la capacité de prédiction de spécularités de notre approche. Nous utilisons notre distance 2D ellipse/point pour évaluer notre résultat de prédiction avec la vérité terrain. Afin de calculer la vérité terrain, nous avons manuellement annoté les spécularités sur les séquences. Nos résultats sont illustrés sur la table \ref{fig:real_res}, la figure \ref{fig:real_data} et la figure \ref{fig:real_data2}.
\begin{figure}[!ht]
   \centering	   
        \subfigure[]
	  { 
  		 \includegraphics[width=0.477\linewidth]{real_example}
        }
        \subfigure[]
	  {
  		 \includegraphics[width=0.47\linewidth]{specu_closeup}
        }   	  
        \subfigure[]
	  {
  		 \includegraphics[width=0.47\linewidth]{spot_real}
        }   	  
        \subfigure[]
	  {
  		 \includegraphics[width=0.47\linewidth]{neon_real}
        } 
   \caption{Nous observons qu'une spécularité présente une forme elliptique. Nous la prédisons en projetant une quadrique virtuelle fixe incluant les propriétés de lumière et de matériau. Cette figure présente des exemples de reconstruction de quadrique (ellipsoïde jaune) pour deux types de lumière (ampoule (c) et néon (d)) et de matériaux (table en fer (c) et plan de travail d'une cuisine (d)). Une fois notre modèle reconstruit, nous l'utilisons pour prédire les spécularités pour des points de vue inconnus en la projetant sous forme d'ellipse (en bleu). (b) illustre un gros plan de la prédiction dans les séquences respectives.}
   \label{fig:real_data}
\end{figure}

\begin{table}[h!]
\caption{Validation empirique de notre modèle et évaluation de sa capacité à prédire la forme des réflexions spéculaires dans les images pour 5 séquences réelles présentées dans les figures \ref{fig:real_data} et \ref{fig:real_data2}. L'erreur moyenne de notre prédiction par spécularité est calculée par notre distance Ellipse/Point entre les ellipses prédites et les contours de spécularités détectées dans l'image. Cette prédiction est évaluée en trois étapes : à l'étape d'initialisation, de la correction épipolaire et du raffinement non-linéaire. Nous observons une baisse significative de l'erreur pour chaque étape.}
\centering
  \begin{tabular}{|c|c|c|c|}
      \hline
        \diagbox{Sequence}{\specialcell{Distance 2D \\ (en pixels)}} &
       \specialcell{Initialisation} & \specialcell{Correction  \\ épipolaire} & \specialcell{Raffinement non-linéaire} \\
      \hline
      \specialcell{Ampoule 1 (table en fer)} & 110.3 & 82.2  &\specialcell{62.8} \\
      \hline
      \specialcell{Néon (Tableau blanc)}  & 210.6 & 80.9  &\specialcell{31.6} \\
      \hline
      \specialcell{Ampoule 2 Livre} & 85.2 &  66.7 & \specialcell{28.9} \\
      \hline
      \specialcell{Ampoule 1 + Néon \\ (table en bois)}  & 162.1 & 96.9 & \specialcell{40.1} \\
      \hline
      \specialcell{Ampoule 1, 2 + néon  \\ (plan de travail de cuisine)} &  240.3 & 144.9  & \specialcell{60.3} \\
      \hline
  \end{tabular}
  \label{fig:real_res}
\end{table}
Dans notre contexte, l'initialisation de quadrique n'est pas suffisante à elle seule pour prédire les spécularités de façon précise. Estimer des contours de spécularité précis est difficile en pratique ce qui impacte fortement la qualité de la reconstruction de la quadrique. En ajoutant un processus de correction épipolaire aux contours d'ellipses en entrée produit de meilleurs résultats. En combinant, la correction épipolaire avec le raffinement non-linéaire, nous atteignons une erreur maximale de 62.8 pixels. Pour des séquences réelles, JOLIMAS est précis et fournit une prédiction de spécularité à partir de nouveaux points de vue pour différents types de sources de lumière et en temps réel.

\begin{figure}[!ht]
    \centering
	\subfigure[]
	{
		\includegraphics[width=0.85\linewidth]{realdata_whiteboard.png}
		\label{fig:realdata_whiteboard}
	}
	\subfigure[]
	{
		\includegraphics[width=0.85\linewidth]{realdata_book.pdf}
	}
	\subfigure[]
	{
		\includegraphics[width=0.85\linewidth]{realdata_book_multi.png}
	}
	\subfigure[]
	{
		\includegraphics[width=0.85\linewidth]{realdata_kitchen.png}
		\label{fig:realdata_kitchen}
	}
\caption{Résultats de prédiction de spécularité sur quatre séquences réelles. Dans (a), un tableau blanc est illuminé par une lampe fluorescente, dans (b) un livre est illuminé par une lampe de bureau, dans (c) une table en bois est illuminée à la fois par une lampe et un néon et dans (d) un comptoir de cuisine est illuminé par deux lampes de bureau et un néon. Notre quadrique est projetée perspectivement sur les différents plans afin de correspondre aux spécularités dans l'image (ellipses bleues). Nous calculons également le symétrique de la quadrique à partir des normales des plans (tableau blanc, table en bois, comptoir de cuisine et couverture de livre) afin de montrer le rapport entre la quadrique de JOLIMAS (en jaune) et les sources de lumière. On remarque que le symétrique de la quadrique est très proche de la position des sources de lumière.}
	\label{fig:real_data2}
\end{figure}

%=============================================================================
\section{Limites de l'approche} 
\label{sec:limite_de_lapproche}
% ==============
\subsection{Surfaces miroirs et spécularités à forme non-elliptique}
Dans le cas d'une surface parfaitement spéculaire telle qu'un miroir, nous ne pouvons pas garantir la forme elliptique de la spécularité puisque les sources de lumière peuvent avoir des formes diverses et variées (comme les lumières de plafond polygonales). Nous considérons le cas général des lumières de type ampoule et néons, ce qui inclut la plupart des sources de lumière que l'on retrouve dans un contexte intérieur. Même pour une surface de faible rugosité, notre méthode est toujours capable de reconstruire un modèle JOLIMAS. 
%Cependant, le cas de surface miroir reste rare et difficile même pour les méthodes de localisation de caméra.
 Une extension de notre méthode serait d'utiliser quelques idées de \cite{heitz2016real} qui modèle de façon efficace les sources de lumière polygonales. %comme illustré à la figure \ref{fig:polygonal_light}.
%\begin{figure}[!ht]
%	\centering
%	\subfigure[]
%	{
%	    \includegraphics[width=0.43\linewidth]{poly_light1.PNG}
%	}
%	\subfigure[]
%	{
%	    \includegraphics[width=0.43\linewidth]{poly_light2.PNG}
%	}
%	\caption{Exemples de sources de lumière polygonales présentée dans l'approche de \cite{heitz2016real} dans des séquences synthétiques. Ce type de sources de lumière n'est pas géré par le modèle JOLIMAS.}
%\end{figure}

\subsection{Influence de la rugosité de la surface} 
Dans le cas des surfaces à forte rugosité, puisque les normales de la surface varient fortement à un niveau microscopique (la surface paraît plane dans l'ensemble), la forme d'une spécularité peut s'éloigner de la forme elliptique initiale. Ces variations ne sont pas incluses dans notre modélisation de spécularité et peuvent affecter la qualité de la reconstruction de quadrique de JOLIMAS. Nous verrons dans le chapitre \ref{chapitre:modele_general} la manière dont nous avons étudié le lien entre variation de normales et forme de spécularité sur la surface de façon similaire à l'approche de \cite{blake1988geometry}.


%=============================================================================
\section{Conclusion} 
\label{sec:conclusion_primal} 
% ==============
Dans ce chapitre, nous avons présenté notre modèle de prédiction de spécularité appelé \textit{JOint LIght-MAterial Specularity} (JOLIMAS). Notre modèle repose sur l'observation que les spécularités présentent une forme elliptique sur une surface plane. Nous avons démontré en détail que les modèles de réflexion de Phong et Blinn-Phong pouvaient être utilisés en bases théoriques pour confirmer la pertinence de notre approximation. Nous avons empiriquement validé cette approximation pour des sources de lumière ponctuelles et étendues. En géométrique projective, une projection de quadrique génère une ellipse. En démontrant l'existence d'une quadrique fixe dont la projection est associée au contour d'une spécularité sur un point de vue, nous avons montré un lien entre photométrie (lumières et matériaux) et géométrie multi-vue (quadrique). La quadrique est reconstruite à partir d'ellipses qui correspondent aux contours des spécularités. Ce modèle a été testé sur des données synthétiques et réelles pour des sources de lumière variées en forme et type telles que des lampes de bureau, ampoules et néons.  
Les contributions évoquées dans ce chapitre ont fait l'objet d'une publication dans une conférence internationale :  ISMAR \citeyearpar{morgand2016geometric}, 2 conférences nationales : deux articles à ORASIS \citeyearpar{morgand2015reconstruction}, RFIA \citeyearpar{morgand2015modele} et un brevet accepté en juin 2016. Le détecteur de spécularité évoqué dans les annexes a fait l'objet d'une publication dans une conférence internationale \cite{morgand2014generic}.
Le chapitre suivant \ref{chapitre:dual_jolimas} évoque l'extension de notre modèle JOLIMAS à des surfaces courbes. 
